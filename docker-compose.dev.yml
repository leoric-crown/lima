# LIMA - Development Override
# Adds n8n-mcp for AI-assisted workflow development
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
#
# Or use Makefile:
#   make dev-up

services:
  # n8n-mcp: AI assistant for n8n workflow development
  # Provides Claude Code / Cursor / Windsurf with n8n documentation and workflow management
  # GitHub: https://github.com/czlonkowski/n8n-mcp
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: lima-n8n-mcp
    restart: unless-stopped
    depends_on:
      n8n:
        condition: service_healthy
    environment:
      NODE_ENV: production
      N8N_MODE: "true"
      MCP_MODE: http
      MCP_AUTH_TOKEN: ${MCP_AUTH_TOKEN:?MCP_AUTH_TOKEN is required}
      AUTH_TOKEN: ${MCP_AUTH_TOKEN}
      N8N_API_URL: http://n8n:5678
      N8N_API_KEY: ${N8N_API_KEY:-}
      LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
    ports:
      - "${MCP_PORT:-8042}:3000"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # postgres-mcp: MCP server for direct database access (SSE transport)
  # Useful for querying embeddings and transcript data directly
  # Connect via: http://localhost:8700/sse
  postgres-mcp:
    image: crystaldba/postgres-mcp:latest
    container_name: lima-postgres-mcp
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URI: postgresql://${N8N_DB_USER:-n8n_user}:${N8N_DB_PASSWORD}@postgres:5432/${POSTGRES_DB:-lima}
    command: ["--access-mode=unrestricted", "--transport=sse"]
    ports:
      - "${POSTGRES_MCP_PORT:-8700}:8000"
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/sse', timeout=2)\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lima-pgadmin
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/misc/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  pgadmin_data:
    name: lima_pgadmin_data
